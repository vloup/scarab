#set ($canAddComment    = $scarabR.hasPermission($scarabG.Permission.ISSUE__COMMENT, $module) && $rmit.Active)
#set ($wantEdit         = $scarabU.wantEdit($user,$currentIssue,$data))
#set ($isEditAttributes = $canEdit && $wantEdit)

<h3 onClick=smartToggleVisibility('properties')><img name="properties.state" src="$staticLink.setPath($iconCollapse)"/>$l10n.IssueAttributesNavi</h3>
<div id='properties'>

  ## ------------------------------------------------------------------
  ## Setup the top row of the Issue attributes tab.
  ## The row contains:
  ## 
  ## IssueType
  ## IssueId
  ## Associated active user (if exists)
  ## Date of creation
  ## Date of last change
  ## -------------------------------------------------------------------
  
  
  ## ===============================================================================
  ## The Tab header
  ## ===============================================================================
  
  
  <div class="header">
    <div class="group">
      <table>
        <tr>
          <th>$currentIssue.RModuleIssueType.DisplayName</th>
          <td>$currentIssue.UniqueId</td>
        </tr>
        <tr>
          <th>$assignedRMA.DisplayValue</th>
          <td> #assignedUsers( $myself $isEditAttributes )</td>
        </tr>
      </table>
      
    </div>

    <div class="group">
      <table>    
        <tr>
          <th>$l10n.DateCommitted</th>
          #userTimeStamp_td( $currentIssue.CreatedBy $currentIssue.CreatedDate)
        </tr>
        <tr>
          <th>$l10n.LastModified</th>
          #userTimeStamp_td( $currentIssue.ModifiedBy $currentIssue.ModifiedDate)
        </tr>
      </table>
    </div>

    <div class="group">
      <table>    
        #if ($currentIssue.isBlocked())      
          <tr>
            <td>
              <a class="blockedmark" STYLE="text-decoration: none" title="$l10n.IssueCurrentlyBlocked" href='$tabLink.addPathInfo("tab", "6")'>$l10n.BlockedWarning</a>
            </td>
          </tr>
        #end
        #if ($currentIssue.isBlockingAnyIssue())
          <tr>
            <td>
              <a class="blockingmark" STYLE="text-decoration: none" title="$l10n.IssueDoesBlockOtherIssues" href='$tabLink.addPathInfo("tab", "6")'>$l10n.BlockingWarning</a>
            </td>
          </tr>
        #end
      </table>
    </div>
    
  </div>

  ## ===============================================================================
  ## The Attribute-groups area
  ## ===============================================================================

  <div class="axial">
    #foreach ($group in $issueType.getAttributeGroups($module, true))
      #set ($attributes = $group.Attributes)
      #if ($attributes && !$attributes.isEmpty() && $group.isVisible4User($user))
        <h4>$group.Name #if ($isEditAttributes)#asterisk()#end</h4>
        <table cellpadding="3" cellspacing="2" border="0" width="100%">
          #set ($appendToNextLine = "")
          #foreach ($att in $attributes)
            #set ($rma = $module.getRModuleAttribute($att, $issueType))
            #if ($rma.Active)
              #set ($attVal = $attrValues.get($att.getName().toUpperCase()))
              #set ($attrInput = $intake.AttributeValue.mapTo($attVal))
              #if ($att.AttributeType.ValidationKey)
                #set ($field = $attVal.Attribute.AttributeType.ValidationKey)
              #elseif ($att.isOptionAttribute())
                #set ($field = "OptionId")
              #else
                #set ($field = "Value")
              #end
              #if ($isEditAttributes)
                #set ($fieldSize = 0)
                #set ($fieldSize = $!attVal.Attribute.FieldSize)
                #set ($fieldHint  = "")
                #set ($fieldHint  = $!attVal.Attribute.Hint)
                #set ($fieldExtraHeader = "")
                #if  ($!attVal.Attribute.Description.startsWith("hint:"))
                  #set ($fieldExtraHeader = "$!attVal.Attribute.Description.substring(5)")
                #end

                #set ($index = $rma.DisplayValue.indexOf(":") + 1)
                #if ($index > 1)
                  #set ($displayValue = $rma.DisplayValue.substring($index))
                  #set ($appendToNextLine = [$rma, $displayValue,  $fieldExtraHeader, $att, $attVal, $field, $fieldSize, $fieldHint, $attrInput])
                #else
                  <tr>
                    <th style="white-space:nowrap;"> 
                      #if ($rma.getRequired() || ( $field.equals("OptionId") && $rma.isRequiredIf($attVal.getOptionId()))) #showAsterisk()#end$rma.DisplayValue
                      #if($fieldExtraHeader)
                      <pre>$fieldExtraHeader</pre>
                      #end
                    </th>
                    <td>
                      #if ($att.isOptionAttribute())
                        #attrValueLeafSelect ($attVal $field "" false $attVal.isRequired())
                        #attrValueErrorMsg ($attVal $field)
                      #elseif ($att.isIntegerAttribute())
                        #attrValueErrorMsg($attVal "NumericValue")
                        #attrValueText($attVal $attrInput.NumericValue $fieldSize $fieldHint)
                      #else
                        #attrValueErrorMsg($attVal "Value")
                        #attrValueText($attVal $attrInput.Value $fieldSize $fieldHint)
                      #end

                    #if ($appendToNextLine != "")
                      #set ($attIsRequired = ($appendToNextLine.get(0).getRequired() || ($appendToNextLine.get(0).isRequiredIf($attVal.OptionId)) ) )
                      #set ($visibility="hidden")
                      #if ($attIsRequired)
                        #set ($visibility="visible")
                      #end
                      <span id="$appendToNextLine.get(1)" style="visibility:$visibility;">
                        #if ($appendToNextLine.get(0).getRequired() || ($appendToNextLine.get(5).equals("OptionId") && $appendToNextLine.get(0).isRequiredIf($appendToNextLine.get(4).getOptionId) ) )#showAsterisk()#end $appendToNextLine.get(1)
                        #if($appendToNextLine.get(2))
                        <pre>$appendToNextLine.get(2)</pre>
                        #end
                        &nbsp;
                        #if ($appendToNextLine.get(3).isOptionAttribute())
                          #attrValueLeafSelect ($appendToNextLine.get(4) $appendToNextLine.get(5) "" false $appendToNextLine.get(4).isRequired())
                          #attrValueErrorMsg ($appendToNextLine.get(4) $appendToNextLine.get(4))
                        #elseif ($appendToNextLine.get(3).isIntegerAttribute())
                          #attrValueErrorMsg($appendToNextLine.get(4) "NumericValue")
                          #attrValueText($appendToNextLine.get(4) $appendToNextLine.get(8).NumericValue $appendToNextLine.get(6) $appendToNextLine.get(7))
                        #else
                          #attrValueErrorMsg($appendToNextLine.get(4) "Value")
                          #attrValueText($appendToNextLine.get(4) $appendToNextLine.get(8).Value $appendToNextLine.get(6) $appendToNextLine.get(7))
                        #end
                      </span>
                    #end
                    </td>

                  </tr>
                  #set ($appendToNextLine = "")

                #end
              #elseif ($attVal.isSet())

                #set ($displayValue = $attVal.RModuleAttribute.DisplayValue)
                #set ($index = $displayValue.indexOf(":") + 1)
                #if  ($index > 1)
                  #set ($displayValue = $displayValue.substring($index))
                #end
                
              
                #set ($display = true)
                #set ($isOptionAttr = $attVal.Attribute.isOptionAttribute())
                #set ($fieldStyle = "")
                #set ($fieldStyle = $!attVal.Attribute.Style)
                #if ($isOptionAttr)
                  #set ($fieldStyle = $!attVal.AttributeOption.Style)
                  #if ($attVal.AttributeOption.Deleted.toString().equals("true"))
                    #set ($display = false)
                  #end
                #end
                #if ($display)
                  <tr>
                    <th>$displayValue</th>
                    <td $fieldStyle >
                      #set ($attrInput = $intake.AttributeValue.mapTo($attVal))
                   
                      ## Output the value of the attribute. How this is done
                      ## depends on the attribute type.
                      #if ($isOptionAttr)
                        #if (!$attVal.AttributeOption)
	                          --
	                        #else
                          #if ($module.getRModuleOption($attVal.AttributeOption, $issueType).Active)
                            $!module.getRModuleOption($attVal.AttributeOption, $issueType).DisplayValue
                          #else
                           [I]$!module.getRModuleOption($attVal.AttributeOption, $issueType).DisplayValue
                          #end
                        #end
                      #elseif ($att.AttributeType.Name == "long-string")
                        ## Convert the raw text to formatted HTML before
                        ## displaying it.
                        $!scarabG.textToHTML($attrInput.Value.toString(), $link, $scarabR.CurrentModule)
                      #elseif ($att.AttributeType.Name == "date")
                        $scarabR.formatDate($!attrInput.Value.value)
                      #elseif ($att.AttributeType.Name == "integer")
                        $!attrInput.NumericValue.value
                      #else
                        ## Just output the raw value directly.
                        $!attrInput.Value
                      #end
                    </td>
                  </tr>
                #end
              #end
    
            #else
	              #set ($allAttrValues = $currentIssue.getModuleAttributeValuesMap(false))		
              #set ($attVal = $allAttrValues.get($att.getName().toUpperCase()))
              #set ($attrInput = $intake.AttributeValue.mapTo($attVal))
              #set ($isOptionAttr = $attVal.Attribute.isOptionAttribute())
              #if ($attVal.isSet() && (!$attrInput.Value.toString().trim().equals("") || !$attrInput.NumericValue))
                <tr>
              	  <th>[I] $rma.DisplayValue</th>
                  <td>
                    #if ($isOptionAttr)
			                      #if ($module.getRModuleOption($attVal.AttributeOption, $issueType).Active)
                        	$!module.getRModuleOption($attVal.AttributeOption, $issueType).DisplayValue
			                      #else
                        	[I]$!module.getRModuleOption($attVal.AttributeOption, $issueType).DisplayValue
			                      #end
                    #elseif ($att.AttributeType.Name == "integer")
                      $!attrInput.NumericValue.value
                    #else
                      $!attrInput.Value
                    #end 
                  </td>
                </tr>
	              #end
            #end 
          #end
        </table>
      #end
    #end
  </div>
 
 
  ## ===============================================================================
  ## The reason field (if visible)
  ## ===============================================================================
  
  #set ($reasonIsVisible  = $module.isIssueReasonVisible()  )
  #if ($isEditAttributes)
    #set ($attCommentGroup = $intake.Attachment.setKey("attCommentKey$currentIssue.QueryKey"))
    #if ($reasonIsVisible)
      #set ($reasonIsRequired = $module.isIssueReasonRequired() )    
      <h4>$l10n.SaveChanges#if($reasonIsRequired) #asterisk()#end</h4>
      <div class="axial">
        <table cellpadding="3" cellspacing="2" border="0" width="100%">
          <tr>
              <th nowrap="nowrap">#if($reasonIsRequired)#showAsterisk()#end$l10n.ReasonSavedAs</th>
              <td>
                  <input type="radio" name="saveReasonAs" value="history" checked="checked"> $l10n.History</input>
                  #if ($canAddComment)
                      <input type="radio" name="saveReasonAs" value="comment" > $l10n.Comment </input>
                  #end
                  $l10n.EnterReasonAs

                  #fieldErrorMsg($attCommentGroup.Data "")
                  <p>#textAreaMedium("$attCommentGroup.Data.Key" $attCommentGroup.Data.Value)</p>
              </td>
          </tr>
        </table>
      </div>
    #else
      <input type="hidden" name="$attCommentGroup.Data.Key" value="" />
    #end
    <input type="hidden" name="$attCommentGroup.Name.Key" value="comment" />
  #end

  ## ===============================================================================
  ## The local function bar for this Tab
  ## ===============================================================================

  #if($canEdit)
    <div class="functnbar3">
     #if(!$isEditAttributes)
        <input type="submit" value="$l10n.Edit" name="eventSubmit_doEditattributespage" />
     #end
     #if($isEditAttributes)
      <input type="submit" value="$l10n.Done"   name="eventSubmit_doSubmitattributes" />
      <input type="submit" value="$l10n.Cancel" name="eventSubmit_doCancel" />
      <input type="hidden" value="false"        name="edit_attributes" />
     #end
    </div>
  #end

</div>

