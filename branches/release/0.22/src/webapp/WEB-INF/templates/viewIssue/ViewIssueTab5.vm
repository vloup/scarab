#set ($allActivitySets = $scarabG.reverse($currentIssue.activitySets))
#if (!$fullHistory.equals("true"))
  #set ($allActivitySets = $scarabG.subset($allActivitySets, 0, $currentIssue.HistoryLimit))
#end

#if (!$allActivitySets.isEmpty())
<h3 onClick=smartToggleVisibility('history')><img name="history.state" src="$staticLink.setPath($iconCollapse)"/>$l10n.ChangeHistory</h3>
<div id="history">

  #foreach ($activitySet in $allActivitySets)
    <h4>
      #set ($activitySetUser = $scarabR.getUser($activitySet.CreatedBy))
      #userTimeStamp( $activitySetUser $activitySet.CreatedDate)
    </h4>
    #set ($activities = $activitySet.getActivityListForHistory($currentIssue))
    <div class="axial">
    <table width="100%">
    #foreach ($act in $activities)
        #if($currentIssue.isAttributeVisible($act.attribute, $user))
          #set ($newValue = $act.getNewValue($l10n))
          #set ($oldValue = $act.getOldValue($l10n))
          <tr>
            <th width="14%">$act.getDisplayName($l10n)</th>
            #if( $oldValue.length()>0 )
              <td width="43%">$!scarabG.textToHTML($newValue, $link, $scarabR.CurrentModule)</td>
              <td width="43%">$!scarabG.textToHTML($oldValue, $link, $scarabR.CurrentModule)</td>
            #else
              <td colspan="2" width="86%">$!scarabG.textToHTML($newValue, $link, $scarabR.CurrentModule)</td>
            #end
        #else
          $l10n.RestrictedActivityDescription<br/>
        #end
      </tr>
    #end

    #set ($reason = $activitySet.getCommentForHistory($currentIssue))
    #if($reason.length()>0)
      <tr>
      <td colspan="3" width="100%">$!scarabG.textToHTML($reason, $link, $scarabR.CurrentModule)</td>
      </tr>
    #end
    </table>
    </div>
  #end

#if ($currentIssue.isHistoryLong())
   <div class="functnbar3">
  #if ($fullHistory.equals("true"))
    #set ($historyLink = $link.setPage("$template").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "false").addPathInfo("tab", "5"))
    #foreach ($issueId in $data.Parameters.getStrings("issue_ids"))
      #set ($historyLink = $historyLink.addPathInfo("issue_ids", $issueId))
    #end
    #if ($resultsPerPage)
      #set ($historyLink = $historyLink.addPathInfo("resultsPerPage", $resultsPerPage))
    #end
    <p><a href="$historyLink">$l10n.HideCompleteHistory</a></p>
  #else
    #set ($historyLink = $link.setPage("$template").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "true").addPathInfo("tab", "5"))
    #foreach ($issueId in $data.Parameters.getStrings("issue_ids"))
      #set ($historyLink = $historyLink.addPathInfo("issue_ids", $issueId))
    #end
    #if ($resultsPerPage)
      #set ($historyLink = $historyLink.addPathInfo("resultsPerPage", $resultsPerPage))
    #end
    <p><a href="$historyLink">$l10n.ShowCompleteHistory</a></p>
  #end
  </div>
#end
</div>
#end
