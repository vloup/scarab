SCB1407 - Automatic Login in Windows
====================================

This branch is intended to provide the means for automatic login on
Windows networks. Initially based on code provided by Peter Nei (thanks!), current implementation
is mostly based on JCIFS (see note at the end of this doc).

It's implemented as a new valve in the pipeline (NtlmLoginValve), that
will try to get the credentials from the browser using the ntlm challenge
protocol.

The credentials sent by the browser are not trusted directly, and they're authenticated in a NTLM domain.

Given that feature is not automatically cross-browser (it needs some config tweaks in Firefox, and it's not
guaranteed to work on every browser), it might only makes sense in controlled network environment.

== Behaviour ==

The NTLM login will be inactive by default, and it will be activated
using two scarab properties:

  scarab.login.ntlm.active=true|false

The setting of this property to 'true' will require the authentication domain to be defined:

  scarab.login.ntlm.domain=mydomaincontroller

When browsing, the NTLMLoginValve will try to get the credentials and validate them against the NTLM domain.
If they are valid. it will try logging in the user into Scarab.
** For this to succeed, the NTLM usename must match an Scarab username. **
If the user gets logged in, a message will be displayed, such as

    "You've been automatically logged in using your user 'YourUser' from domain 'YourDomain'."

If anyone from the NTLM credentials or its equivalent Scarab username are invalid, the valve will
just 'pass' and the rest of the login system will proceed (Login form / Anonymous)

When an authenticated user (even Anonymous) click on the 'Logout/Login' link, the session will be
terminated and the Login.vm screen will be displayed, so any user (NTLM or not) can try logging
in the system with other credentials.

== Single-Sign-On behaviour ==

User are still able to login using the old form, and this cause a small problem because Scarab's and NTLM's
passwords will not be synchronized.

Possible solutions:
a) Disable form-login: This would be a problem if some users are not to be in the Windows domain.
b) Use a UserPreference to choose between NTLM and form login for every user. This would effectively restrict
any user to only one authentication method, be Scarab or NTLM, but it would add another administration task.
password in Scarab, the NTLM PASSWORD WILL NOT CHANGE, and neither . Similarly, the Windows domain can revoke or 

=== Login precedences ===

 The different login methods allowed will be selected in this order:
 - First: Login form will always take precedence on others.
 - Second: If the login-form has not been used, the system will try NTLM authentication (if activated!)
 - Third: Anonymous login will be granted if allowed.

=== Firefox ===

- Firefox users will be by default prompted with a dialog box asking for username and password. To
do login with Windows domain credentials, the user will have to fill them up using the DOMAIN\User format.
  Example: Username: "MyDomain\mywindowsuser", Password: myplainpassword
  
- If firefox users want to automatically (no dialog!) get the credentials fed from the underlaying Windows
operative system, the have to:
  * Type "about:config" in the URL box.
  * Search for the 'network.automatic-ntlm-auth.trusted-uris' configuration value.
  * Add the name of the Scarab host to that value.

=== Other browsers ===
- The feature has not been tested on other browsers. At least, they would probably offer the dialog asking
for username & password, but it might vary.

== TODO ==

jcifs (http://jcifs.samba.org) is LGPL, but it don't seem to exist a good-enough alternative library.
Some apache projects have been using it (Lenya) providing a mock jar to allow compiling, and asking the
administrator to manually download the real jar.
This method should fit Scarab too, so I haven't 
uploaded (and won't do it) the jcifs jar to Scarab's maven repository. If any, we'll provide the
mock, but this must still be cleared up.
I guess using maven would solve this issue as long as we don't distribute the jar, but I fear this
will not be compatible with the new installer in progress (I suppose it's not supposed to require
internet connection to work!)

