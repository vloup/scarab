#set ($allActivitySets = $scarabG.reverse($currentIssue.activitySets))
#if (!$fullHistory.equals("true"))
  #set ($allActivitySets = $scarabG.subset($allActivitySets, 0, $currentIssue.HistoryLimit))
#end

#if (!$allActivitySets.isEmpty())
<h3 onClick=smartToggleVisibility('history')><img name="history.state" src="$staticLink.setPath($iconCollapse)"/>$l10n.ChangeHistory</h3>
<div id="history">

  <table cellpadding="3" cellspacing="2" border="0" width="100%">
  <tr>
    <th width="30%">$l10n.By,<br>$l10n.DateStamp</th>
    <th width="70%">$l10n.Action, <br> $l10n.Reason </th>
  </tr>
  #foreach ($activitySet in $allActivitySets)
   #set ($activities = $activitySet.getActivityListForIssue($currentIssue))
   #if (!$activities.isEmpty())
  
    #indexedRows($velocityCount)
     <td>
        #set ($actSetUser = $scarabR.getUser($activitySet.CreatedBy))
        <a href="mailto:$actSetUser.Email">$!user.Name</a>
        <br>$format.getDate($scarabR.DateFormat, $activitySet.CreatedDate)
     </td>
     <td>
        #foreach ($act in $activities)
<!-- $act.getDescription($l10n) -->
          #if($currentIssue.isAttributeVisible($act.attribute, $user))
              #set($desc = $act.getDescription($l10n))
              #if ($desc.length()>0) $desc<br/> #end
          #else
              $l10n.RestrictedActivityDescription<br/>
          #end
        #end
        #set ($reason = $activitySet.getActivityReason($l10n))
        $!scarabG.textToHTML($reason, $link, $scarabR.CurrentModule)
     </td>
    </tr>
   #end
  #end
 </table>

#if ($currentIssue.isHistoryLong())
   <div class="functnbar3">
  #if ($fullHistory.equals("true"))
    #set ($historyLink = $link.setPage("$template").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "false").addPathInfo("tab", "5"))
    #foreach ($issueId in $data.Parameters.getStrings("issue_ids"))
      #set ($historyLink = $historyLink.addPathInfo("issue_ids", $issueId))
    #end
    #if ($resultsPerPage)
      #set ($historyLink = $historyLink.addPathInfo("resultsPerPage", $resultsPerPage))
    #end
    <p><a href="$historyLink">$l10n.HideCompleteHistory</a></p>
  #else
    #set ($historyLink = $link.setPage("$template").addPathInfo("id", $currentIssueId).addPathInfo("fullhistory", "true").addPathInfo("tab", "5"))
    #foreach ($issueId in $data.Parameters.getStrings("issue_ids"))
      #set ($historyLink = $historyLink.addPathInfo("issue_ids", $issueId))
    #end
    #if ($resultsPerPage)
      #set ($historyLink = $historyLink.addPathInfo("resultsPerPage", $resultsPerPage))
    #end
    <p><a href="$historyLink">$l10n.ShowCompleteHistory</a></p>
  #end
  </div>
#end
</div>
#end
